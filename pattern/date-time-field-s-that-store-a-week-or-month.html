<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,datetime,date,week,query,django-orm,django-model,django-model-fields "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Date(Time)Fields that store a week or month"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Date(Time)Fields that store a week or month &#8249; pattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/pattern.html><i class="fas fa-shapes"></i>&nbsp;
pattern</a><li class="breadcrumb-item active" aria-current=page><code>Date</code>(<code>Time</code>)<code>Field</code>s that store a week or month</ol></nav><ul class="nav pull-right doc-info"></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>Sometimes we might want to specify a week in a certain month, such that when we filter with a specific date, we look if that date is in the same week as the one stored in the model.<p>We can solve this for example with an <code>IntegerField</code> and then determine the number of weeks since a specific date, for example January 1<sup>st</sup>, 1990<a href=#fn1 class=footnote-ref id=fnref1 role=doc-noteref><sup>1</sup></a>.<p>The problem with such an <code>IntegerField</code> is that it takes a way a lot of convenience to determine the week number. For example when filtering for a specific week it requires that the programmer will need to convert the datetime object to a week number. It will require a lot of logic for example to join two items, or compare one week with a <code>date</code> object.<h1 id=what-problems-are-solved-with-this>What problems are solved with this?</h1><p>In this pattern we will discuss an approach to define extra fields like a <code>WeekField</code> and a <code>MonthField</code>. These fields will aim to implement querying in a <em>transparent</em> manner. The model fields will truncate the <code>date</code>(<code>time</code>) object to the start of the week or the month respectively, and also truncates the operands in case filtering is done with these fields.<h1 id=what-does-this-pattern-look-like>What does this pattern look like?</h1><p>Django's <code>DateField</code> is designed to store a given date. When creating a new field, the two methods that one often has to implement are <a href=https://docs.djangoproject.com/en/dev/ref/models/fields/#django.db.models.Field.to_python><strong><code>to_python(…)</code></strong> <sup>[Django-doc]</sup></a> and <a href=https://docs.djangoproject.com/en/dev/ref/models/fields/#django.db.models.Field.get_db_prep_value><strong><code>get_db_prep_value(…)</code></strong> <sup>[Django-doc]</sup></a>. The first one is used to transform data from the database to its Python counter part<a href=#fn2 class=footnote-ref id=fnref2 role=doc-noteref><sup>2</sup></a> whereas the latter is used to convert items to their database counterpart. The <code>.get_db_prep_value(…)</code> method will thus, for a <code>DateField</code> and <code>DateTimeField</code>, convert the <code>date</code> and <code>datetime</code> objects to a certain format the specific database backend understands. For example <code>2021-09-04</code>.<p>What is interesting is that the <code>.get_db_prep_value(…)</code> method will call the <code>.get_prep_value(…)</code> function that will, on its turn call the <code>.to_python(…)</code> method. This thus means that both when serializing and serializing the data, the data is passed through the <code>.to_python(…)</code> method. Indeed, we see this if we <a href=https://github.com/django/django/blob/stable/3.2.x/django/db/models/fields/__init__.py#L1264-L1272>inspect the source code <sup>[GitHub]</sup></a>:<blockquote><pre class=python><code>class DateField(DateTimeCheckMixin, Field):
    # &hellip;

    def get_prep_value(self, value):
        value = super().get_prep_value(value)
        return self.<b>to_python(</b>value<b>)</b>

    def get_db_prep_value(self, value, connection, prepared=False):
        # Casts dates into the format expected by the backend
        if not prepared:
            value = self.<b>get_prep_value(</b>value<b>)</b>
        return connection.ops.adapt_datefield_value(value)</code></pre></blockquote><p>We can make use of this by overriding the <code>.to_python(…)</code> method, and truncate the <code>date</code>/<code>datetime</code> to the corresponding week, month, etc. We thus can work with a <code>DateTruncMixin</code> that is implemented as:<pre class=python><code>class DateTruncMixin:

    def truncate_date(self, dt):
        return dt

    def to_python(self, value):
        value = super().to_python(value)
        if value is not None:
            return self.truncate_date(value)
        return value</code></pre><p>we here thus make a mixin that will, in case the datetime is not <code>None</code> call the <code>truncate_date</code> which by default does not truncate.<p>With this mixin, we can implement fields that truncate like a <code>WeekField</code> and a <code>MonthField</code>. In this example a week starts on <em>Monday</em>:<pre class=python><code>from datetime import timedelta
from django.db.models import DateField

class WeekField(DateTruncMixin, DateField):
    
    def truncate_date(self, dt):
        return dt - timedelta(days=dt.weekday())


class MonthField(DateTruncMixin, DateField):

    def truncate_date(self, dt):
        return dt - timedelta(days=dt.day-1)</code></pre><p>The same logic can be applied for <code>DateTimeField</code>s:<pre class=python><code>from django.db.models import DateTimeField

class MinuteField(DateTruncMixin, DateTimeField):
    
    def truncate_date(self, dt):
        return dt.replace(second=0, microsecond=0)


class HourField(DateTruncMixin, DateTimeField):

    def truncate_date(self, dt):
        return dt.replace(minute=0, second=0, microsecond=0)</code></pre><p>Now we can thus implement variants for a <code>WeekField</code>, <code>MonthField</code>, <code>QuarterField</code>, 'SeasonField', etc. The idea is that we can use this for querying, creating, and updating values in a model that uses such field.<p>We can for example make a simple <code>Week</code> model with a <code>WeekField</code>:<pre class=python><code>from django.db import models

class Week(models.Model):
    week = WeekField(unique=True)</code></pre><p>Now we can start creating <code>Week</code> objects. If we create the same <code>Week</code> object twice with <a href=https://docs.djangoproject.com/en/dev/ref/models/querysets/#get-or-create><strong><code>.get_or_create(…)</code></strong> <sup>[Django-doc]</sup></a>, then the second time it will use the old <code>Week</code> object, even if we query with another <code>date</code> of the same week, it will retrieve the <code>Week</code> object created by the first creation call. We can for example use two dates of the 35<sup>th</sup> week of 2021:<pre class=pycon><code>&gt;&gt;&gt;&gt; Week.objects.get_or_create(week=&#39;2021-09-04&#39;)
(&lt;Week: Week object (1)&gt;, True)
&gt;&gt;&gt; Week.objects.get_or_create(week=&#39;2021-08-31&#39;)
(&lt;Week: Week object (1)&gt;, False)</code></pre><p>In the database the date is stored as <code>2021-08-30</code>:<div class=sourceCode id=cb2><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a>mysql<span class=op>&gt;</span> <span class=kw>SELECT</span> <span class=op>*</span> <span class=kw>FROM</span> week;</span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a><span class=op>+</span><span class=co>----+------------+</span></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a>| <span class=kw>id</span> | week       |</span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=op>+</span><span class=co>----+------------+</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a>|  <span class=dv>1</span> | <span class=dv>2021</span><span class=op>-</span><span class=dv>08</span><span class=op>-</span><span class=dv>30</span> |</span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true tabindex=-1></a><span class=op>+</span><span class=co>----+------------+</span></span>
<span id=cb2-7><a href=#cb2-7 aria-hidden=true tabindex=-1></a><span class=dv>1</span> <span class=kw>row</span> <span class=kw>in</span> <span class=kw>set</span> (<span class=fl>0.00</span> sec)</span></code></pre></div><p>We thus can also compare two <code>WeekField</code>s effectively to check if they point to the same week. If for example our <code>Week</code> model would have a second field <code>week2</code>, then we can filter with <code>Week.objects.filter(week=F('week2'))</code> to check if the two fields are equivalent.<p>We can also retrieve the <code>Week</code> object we created with the start of the week as value for the <code>week</code> attribute:<pre class=pycon><code>&gt;&gt;&gt; week = Week.objects.get(pk=1)
&gt;&gt;&gt; week.week
datetime.date(2021, 8, 30)</code></pre><p>If we change the <code>week</code> to another <code>date</code> object, and save the object again, it is updated to the start of the week of that date object. If we query for the old week, then we do not get any object:<pre class=pycon><code>&gt;&gt;&gt; from datetime import date
&gt;&gt;&gt; week.week = date(2021, 9, 8)
&gt;&gt;&gt; week.save()
&gt;&gt;&gt; Week.objects.get(week=&#39;2021-9-6&#39;)
&lt;Week: Week object (1)&gt;
&gt;&gt;&gt; Week.objects.filter(week=&#39;2021-09-04&#39;)
&lt;QuerySet []&gt;</code></pre><p>There are still some issues when comparing the value for a <code>WeekField</code> with the value of a <code>DateField</code> for example, since the <code>WeekField</code> is, behind the curtains, just a <code>DateField</code> that is set to the beginning of the week. We however think that the fields defined above will result in more programmer convenience.<section class=footnotes role=doc-endnotes><hr><ol><li id=fn1 role=doc-endnote><p>since the first week of 1990 starts on a Monday.<a href=#fnref1 class=footnote-back role=doc-backlink>↩︎</a><li id=fn2 role=doc-endnote><p>for example converting a JSON blob to Python objects.<a href=#fnref2 class=footnote-back role=doc-backlink>↩︎</a></ol></section></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>