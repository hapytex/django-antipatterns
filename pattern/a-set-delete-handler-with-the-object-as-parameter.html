<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,deletion handler,django-models "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="A SET(…) delete handler with the object as parameter"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>A SET(…) delete handler with the object as parameter &#8249; pattern &#8249; Django antipatterns</title>
<link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/pattern.html><i class="fas fa-shapes"></i>&nbsp;
pattern</a><li class="breadcrumb-item active" aria-current=page>A <code>SET(…)</code> delete handler with the object as parameter</ol></nav><ul class="nav pull-right doc-info"></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>Django models offer to specify a piece of logic that will run for objects that refer to an object through a <code>ForeignKey</code> or <code>OneToOnField</code> if that object these refer to is removed.<p>Often handlers like <a href=https://docs.djangoproject.com/en/dev/ref/models/fields/#django.db.models.CASCADE><strong><code>CASCADE</code></strong> <sup>[Django-doc]</sup></a> or <a href=https://docs.djangoproject.com/en/dev/ref/models/fields/#django.db.models.SET><strong><code>SET(…)</code></strong> <sup>[Django-doc]</sup></a> are often picked to remove the object that refers to the object, or let the <code>ForeignKey</code> point to a new object respectively. While <code>SET(…)</code> can be given a callable, but it takes <em>no</em> parameters.<p>Often, it is useful to be given the instance where the modification should take place, such that a method based on the data of that instance, can provide a new value for the <code>ForeignKey</code> or <code>OneToOneField</code>. With this pattern, we make it also possible to perform a cascaded delete based on that instance.<h1 id=what-problems-are-solved-with-this>What problems are solved with this?</h1><p>Consider the following model:<pre class=python><code>from django.conf import settings
from django.db import models
from <i>app_name</i>.deletion import SET_WITH

def new_organizer(meeting):
    # &hellip;
    pass

class Meeting(models.Model):
    organizer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=SET_WITH(new_organizer),
        related_name='organized_meetings'
    )
    members = models.ManyToManyField(
        settings.AUTH_USER_MODEL
    )</code></pre><p>Here we have a model <code>Meeting</code> that is linked to multiple <code>participants</code>, and one <code>organizer</code>. If the <code>User</code> object that is the <code>organizer</code> is removed, another person that is a participant is upgraded as <code>organizer</code>. In case there are no participants anymore, the meeting object should be removed.<p>For this we will implement the <code>SET_WITH</code> deletion handler. This will make a call to the <code>new_organizer</code> function, which will return a new value for the <code>organizer</code>, or can also signal that the <code>Meeting</code> object should be removed as well, so with a <em>cascade</em> removal.<h1 id=what-does-this-pattern-look-like>What does this pattern look like?</h1><p>We can take a look at the <a href=https://github.com/django/django/blob/stable/4.0.x/django/db/models/deletion.py#L46-L54>implementation of the <code>SET</code> handler <sup>[GitHub]</sup></a>:<blockquote><pre class=python><code>def SET(value):
    if callable(value):
        def set_on_delete(collector, field, sub_objs, using):
            collector.add_field_update(field, value(), sub_objs)
    else:
        def set_on_delete(collector, field, sub_objs, using):
            collector.add_field_update(field, value, sub_objs)
    set_on_delete.deconstruct = lambda: ('django.db.models.SET', (value,), {})
    return set_on_delete</code></pre></blockquote><p>This function needs to return a function that will then later be called with a <code>collector</code>, <code>field</code>, <code>sub_objs</code> and <code>using</code>. The collector is an object that keeps track on what fields to update to what value, and what items to remove. The field is a reference to the field object that is here triggered. This can be useful, for example to determine the <code>.default</code> attribute. The <code>sub_objs</code> is a collection of objects that needs to be updated. These are all model objects with as model the model where the deletion handler is set. Finally <code>using</code> specifies what database connection should be used to update objects.<p>Here <code>SET</code> will first check if <code>value</code> is a callable of not. If it is not a callable, it will for all the <code>sub_objs</code> specify in the collector that these should be updated with <code>value</code>. If it is a callable, these will all be updated with <code>value()</code>.<p>What we need to change is the fact that not all these <code>sub_objs</code> are updated to <code>value</code>, or <code>value()</code>, but that we <em>call</em> the function with each object in the <code>sub_objs</code>, and for each of these items add the result in the collector.<p>It is possible that we might want to remove a (subset) of the <code>sub_objs</code>. We can do this with by constructing an object <code>DO_CASCADE</code>. In case the function returns <em>that</em> object, then it will be added to the list of items that we will then collect to perform a cascade.<pre class=python><code># <i>app_name</i>/deletion.py

from django.db.models.deletion import CASCADE

DO_CASCADE = object()

def SET_WITH(func):
    def set_on_delete(collector, field, sub_objs, using):
        cascades = []
        for obj in sub_objs:
            <b>result = func(obj)</b>
            if result is DO_CASCADE:
                cascades.append(obj)
            else:
                collector.add_field_update(field, result, [obj])
        if cascades:
            CASCADE(collector, field, cascades, using)
    set_on_delete.deconstruct = lambda: ('<i>app_name</i>.SET_WITH', (func,), {})
    return set_on_delete</code></pre><p>Now that we have implemented the <code>SET_WITH(…)</code> handler, we can use this for the implementation of our <code>new_organizer(…)</code> method. This function takes the <code>Meeting</code> object, and will look for the user object that is not the user that is the <code>organizer</code>, and we check if there is at least such element. If not, we return the <code>DO_CASCADE</code> method to perform a cascaded removal:<pre class=python3><code>from <i>app_name</i>.deletion import DO_CASCADE

def new_organizer(meeting):
    item = meeting.members.exclude(pk=meeting.organizer_id).first()
    if item is None:
        return DO_CASCADE
    return item</code></pre><p>We thus first access the <code>.members</code> and will exclude the <code>organizer_id</code> to prevent assigning the organizer that is not <em>yet</em> removed from the <code>.members</code>. We access the <code>.first()</code> item. If it is <code>None</code>, that means that there are no <code>members</code> left, so then we return <code>DO_CASCADE</code> to ensure that the <code>Meeting</code> object will be removed. In case it returns a user object, we use that as the new value for the <code>.organizer</code>.</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>