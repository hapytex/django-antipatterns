<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,sql,case,when,django-database,django-orm "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Dictionary lookups for the database"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Dictionary lookups for the database &#8249; pattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/pattern.html><i class="fas fa-shapes"></i>&nbsp;
pattern</a><li class="breadcrumb-item active" aria-current=page>Dictionary lookups for the database</ol></nav><ul class="nav pull-right doc-info"></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>It happens occasionally we want to perform a lookup with a dictionary for model records. Indeed, imagine we have a dictionary:<div class=sourceCode id=cb1><pre class="sourceCode python"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a>prices <span class=op>=</span> {</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a>    <span class=dv>13</span>: <span class=fl>2.0</span>,</span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a>    <span class=dv>14</span>: <span class=fl>25.0</span>,</span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a>}</span></code></pre></div><p>and we have a model <code>Product</code> that has an id and that id then determines the prices.<h1 id=what-problems-are-solved-with-this>What problems are solved with this?</h1><p>In an ideal scenario, we store the prices in the database, for example with as an extra column, or with a separate model with a <code>ForeignKey</code> or <code>OneToOneField</code>. This will not only make the lookup a lot easier, it will also perform the JOIN more efficient: JOINs are well-researched to be done as efficient as possible, both with respect to the CPU cycles, as well as memory and disk I/O. So if you have a dictionary of data in memory, it might be better to first store it in a table and then make the JOIN.<p>In a seldom scenario, it might however not be possible, for example because there is no such table, or because we are not allowed to make modifications to the database, or because we want to calculate a price changes, without storing the prices. In that case we thus want to work with a dictionary lookup. The following will however <em>not</em> work:<div class=sourceCode id=cb2><pre class="sourceCode python"><code class="sourceCode python"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=co># will *not* work</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a>Product.objects.annotate(price<span class=op>=</span>prices.get(F(<span class=st>&#39;pk&#39;</span>)))</span></code></pre></div><p>That makes sense because <code>prices</code> is just an ordinary dictionary, and if we make a lookup with an <code>F</code> object, it will simply see there is nothing equivalent to the <code>F</code> object in the dictionary, so return <code>None</code>, and therefore all annotations will be <code>None</code>.<h1 id=what-does-this-pattern-look-like>What does this pattern look like?</h1><p>We can work with a <a href=https://docs.djangoproject.com/en/stable/ref/models/conditional-expressions/#case><strong><code>Case</code>-<code>When</code></strong> expressionÂ <sup>[Django-doc]</sup></a>, this will for each key-value pair make a <code>WHEN</code> clause, like:<pre class=python>from django.db.models import Case, Value, When

Product.objects.annotate(
    prices=<b>Case(*[When(pk=k, then=Value(v)) for k, v in prices.items()])</b>
)</code></pre><p>This will thus make a query that looks like:<div class=sourceCode id=cb3><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> <span class=kw>id</span>,</span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a>    <span class=cf>CASE</span></span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a>        <span class=cf>WHEN</span> <span class=kw>id</span><span class=op>=</span><span class=dv>13</span> <span class=cf>THEN</span> <span class=fl>2.0</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a>        <span class=cf>WHEN</span> <span class=kw>id</span><span class=op>=</span><span class=dv>14</span> <span class=cf>THEN</span> <span class=fl>25.0</span></span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>    <span class=cf>END</span> <span class=kw>as</span> price</span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a><span class=kw>FROM</span> product</span></code></pre></div><p>This is however <em>not</em> efficient: likely the database will enumerate over each case, so it will boil down to <em>linear search</em> making the query computationally expensive. This pattern thus is a solution for a <em>bad</em> problem: ideally, we try to prevent the problem from happening.</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"Â¶"},anchors.add("h1,h2,h3")</script></article></body></html>