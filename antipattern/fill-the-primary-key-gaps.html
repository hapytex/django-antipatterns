<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,url,path,primary-key,django-models,urls,views "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Fill the primary key gaps"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Fill the primary key gaps &#8249; antipattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Fill the primary key gaps</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=3>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>A frequently asked question is how to "<em>fill the gaps</em>" in the primary key range. Indeed, if you have for example a model <code>Article</code> with an <code>AutoField</code>, and you create a few articles, these will have primary keys like <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code>, and <code>5</code>. If we then for example remove an <code>Article</code> with primary key <code>2</code>, then if we add a new <code>Article</code>, it will not "fill the gap" and thus create a new <code>Article</code> with primary key <code>2</code>, but it will make an <code>Article</code> with primary key <code>6</code>.<p>It is understandable that people want to automatically reassign the primary keys of records that have been reassigned. Strictly speaking a database could easily do that, and since the database does not do that, we could run a query to automatically look for the "first" gap. Indeed, we can find the primary key we want with:<div class=sourceCode id=cb1><pre class="sourceCode python"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=co># do not use this</span></span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a><span class=im>from</span> django.db.models <span class=im>import</span> Exists, F, OuterRef</span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true tabindex=-1></a>next_pk <span class=op>=</span> Article.objects.<span class=bu>filter</span>(<span class=op>~</span>Exists(Article.objects.<span class=bu>filter</span>(pk<span class=op>=</span>OuterRef(<span class=st>&#39;pk&#39;</span>)<span class=op>+</span><span class=dv>1</span>))).order_by(<span class=st>&#39;pk&#39;</span>).values_list(F(<span class=st>&#39;pk&#39;</span>)<span class=op>+</span><span class=dv>1</span>, flat<span class=op>=</span><span class=va>True</span>).first() <span class=kw>or</span> <span class=dv>1</span></span></code></pre></div><p>Here we thus look for an <code>Article</code> with a certain primary key, for which no primery key with the next value exists. If we find such <code>Article</code>, we thus return the next primary key. We can assign that value then as the primary key, we even could wrap this in a function and thus use this as default. But it is <em>not</em> a good idea.<h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>First of all, our function will only work when there are no race conditions: it is possible that there are two processes that simultaneously try to create an <code>Article</code>, and could end up with the same primary key. We could wrap these in transactions, slowing down the process. But this problem is indeed more of a technical detail: perhaps it is possible to resolve this.<p>But a more severe problem is that now the URL <code>/article/2</code> no longer points to the <em>old</em> article, but to a new article. People that thus bookmarked the path <code>/article/2</code> expect to see that old article, but see the new one. Search engines could still store references to the old article, but people that click on the link now see a new article. <em>Tim Berners-Lee</em> write a document in 1998 named <a href=https://www.w3.org/Provider/Style/URI.html><em>Cool URIs don't change</em></a> explaining that changing the location of an article is not a good idea, most arguments also hold for reassigning the URL to new data.<p>But the most severe problem is that there can still be a lot of items referring to the old article, that now perhaps refer to the new article. Indeed, imagine that you have a <a href=https://docs.djangoproject.com/en/stable/ref/contrib/contenttypes/#django.contrib.contenttypes.fields.GenericForeignKey><strong><code>GenericForeignKey</code></strong> <sup>[Django-doc]</sup></a>, if there is no <a href=https://docs.djangoproject.com/en/stable/ref/contrib/contenttypes/#django.contrib.contenttypes.fields.GenericRelation><strong><code>GenericRelation</code></strong> <sup>[Django-doc]</sup></a>, it will <em>not</em> be triggered to remove the objects. Indeed, imagine that we have a <code>Tag</code> model with:<div class=sourceCode id=cb2><pre class="sourceCode python"><code class="sourceCode python"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=kw>class</span> TaggedItem(models.Model):</span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a>    tag <span class=op>=</span> models.SlugField()</span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a>    content_type <span class=op>=</span> models.ForeignKey(ContentType, on_delete<span class=op>=</span>models.CASCADE)</span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a>    object_id <span class=op>=</span> models.PositiveIntegerField()</span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a>    content_object <span class=op>=</span> GenericForeignKey(<span class=st>&quot;content_type&quot;</span>, <span class=st>&quot;object_id&quot;</span>)</span></code></pre></div><p>Now if a <code>TaggedItem</code> refers to an <code>Article</code>, and that the <code>Article</code> with primary key is <code>2</code> is removed, then the table for the <code>TaggedItem</code> will still have a record with the <code>content_type</code> for the <code>Article</code> <em>and</em> the <code>object_id</code> that points to <code>2</code>. This means that if a new article is created, then the old tags will thus now point to the new article, and therefore "inherit" the tags of the old article. This can be a severe security issue in case we have models that regulate permissions, and thus use a <code>GenericForeignKey</code>.<p>But the problem is not only with <code>GenericForeignKey</code>s: it is not very rare that there are tables with "weak links" to other tables, and thus still refer to the old article. Perhaps these tables are not even known to Django because these are for example provided by a different system or program. This thus can result in a <em>severe</em> security issue, but also corrupt data, and making all sorts of views and aggregates buggy.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>Don't try to fill the gaps, generate a new primary key that does not collide with <em>removed</em> objects. Just let the database do its work. As discussed, there are good reasons why (most) databases use a strategy that does not fill the gaps. While it may not look very elegant, it is likely a lot better than trying to fill the gaps.</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>