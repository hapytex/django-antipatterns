<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,authentication,logged-in,database-query,django-views "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Fetching the logged in user with a query"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Fetching the logged in user with a query &#8249; antipattern &#8249; Django antipatterns</title>
<link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Fetching the logged in user with a query</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=2>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>If we use Django's <a href=https://docs.djangoproject.com/en/dev/ref/middleware/#module-django.contrib.auth.middleware><strong><code>AuthenticationMiddleware</code></strong> <sup>[Django-doc]</sup></a>, then the <code>HttpRequest</code>s that are passed to the view have an attribute <code>.user</code> that we can use to obtain the logged in user, or the <code>AnonymousUser</code> in case there is no logged in user for that request.<p>Often people make queries to obtain the user object, for example with:<pre class=python><code>from django.contrib.auth.models import User

def my_view(request):
    user = User.objects.get(<b>username=request.user</b>)
    # &hellip;</code></pre><h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>It is <em>unnecessary</em>. The <code>request.user</code> <em>is</em> a user model object. It thus has all the attributes the user model has. By querying the database for the user with the given username, we make an extra query, so now we query twice to obtain user details instead of once.<p>Another problem with this is that we make the views <em>less flexible</em>. Indeed, we here import the user model, if we later decide to use another user model, then we need to rewrite the views. If we would use <a href=https://docs.djangoproject.com/en/dev/topics/auth/customizing/#django.contrib.auth.get_user_model><strong><code>get_user_model(…)</code></strong></a> then it is still not very flexible, since we here make the assumption that the user model will have a <code>username</code>, and that calling <code>str(…)</code> on the user model will return that username. If we thus would migrate to a user model that has only an email address, then we will still have to update the views.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>Use <a href=https://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.user><strong><code>request.user</code></strong> <sup>[Django-doc]</sup></a> directly. This is an object of the actively used user model, so Django's <code>User</code> model by default. It means we do not have to worry about the user model, or how it is linked to the session.<pre class=python><code>def my_view(request):
    user = <b>request.user</b>
    # &hellip;</code></pre><h1 id=extra-tips>Extra tips</h1><p>It is possible that sometimes we want to update the user model with the values stored in the database. Using an explicit query however is not very flexible for the reasons explained above. In that case we can use the <a href=https://docs.djangoproject.com/en/dev/ref/models/instances/#django.db.models.Model.refresh_from_db><strong><code>.refresh_from_db(…)</code></strong> method <sup>[Django-doc]</sup></a> to refresh the data in the <code>request.user</code> object with values from the database:<pre class=python><code>def my_view(request):
    user = request.user
    # &hellip;
    # we want to retrieve the (updated) values from the database
    user<b>.refresh_from_db()</b>
    # &hellip;</code></pre></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>