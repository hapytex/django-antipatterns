<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,migrations,database,deployment,django-models "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Run makemigrations in production"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Run makemigrations in production &#8249; antipattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Run <code>makemigrations</code> in production</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=5>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>In order to deploy a Django app, it is often useful to do some administrative tasks <em>before</em> running the Django application in production, for example <em>migrating</em> the database. By adding this in the deployment workflow, it is less likely that the database will be out of sync with the software, and thus prevents problems.<p>Occasionally people think it is a good idea to also run <code>makemigrations</code> in the deploy flow. One would think that minimizes the odds that you forget to make migrations in the development stage, and thus a change to the models, also immediately generates migration files and can then immediately migrate the database.<h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>Migrating the database is a <em>non-trivial problem</em>. There are multiple ways how you can migrate a database to get the model in sync with the database. Indeed, imagine that you have a model:<div class=sourceCode id=cb1><pre class="sourceCode python"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=im>from</span> django.db <span class=im>import</span> models</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a><span class=kw>class</span> MyModel(models.Model):</span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true tabindex=-1></a>    my_field <span class=op>=</span> models.IntegerField()</span></code></pre></div><p>and we now change the model to:<div class=sourceCode id=cb2><pre class="sourceCode python"><code class="sourceCode python"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=im>from</span> django.db <span class=im>import</span> models</span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=kw>class</span> MyModel(models.Model):</span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a>    my_other_field <span class=op>=</span> models.IntegerField()</span></code></pre></div><p>now there are two reasonable ways how to migrate: assume that the field got <em>renamed</em> and thus retain the data; or assume the <code>my_field</code> was removed, and <code>my_other_field</code> is a new field. In the latter case, the question is what we do with the existing records? What value will we use for <code>my_other_field</code> for records already present in the database.<p>Django's <code>makemigrations</code> command therefore often prompts the user to ask what migration to perform, or needs input on what values to use for <em>existing</em> database records. This thus means that <code>makemigrations</code> can block the deploy flow, by asking for what to do, and since the deployment (typically) does not provide any input, Django will keep waiting for a response.<p>Let us assume that somehow Django does not need any prompts to migrate the database, it can still be quite dangerous: it could for example remove a column from a table, or even the entire table. This means that now the data is <em>gone</em>. If we would have done that in development mode, we could have seen that Django generated a migration that would destroy data, and if we migrated the <em>development</em> database, the data would be gone at that place, but this thus prevents making this mistake at the production side.<p>But even if the migration would somehow be trivial, it is not a good idea. It means the deployment pipeline will make migrations, and migrate the database. This means that in the <code>django_migrations</code> table, it will add an entry to mark that the migration file just generated has been applied. If you thus would copy the production database to the development database, and you run the Django application in development mode, Django will assume that migration <code>app_label.1234_some_message</code> has been applied. Perhaps at the development side, there is also such migration, but not per se the <em>same</em> one. This thus means that the database, based on the migrations, is different at the development side, than on the production side, and this makes debugging a problem harder: it could mean all sorts of queries brake, because the database is not the same, and Django does not see any issue when you would run <code>makemigrations</code>, because it sees the migrations generated in development mode, and it sees that these migrations have been marked as done by the database.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>Run <code>makemigrations</code> when you <em>develop</em> the application. Test the migrations in development mode (preferably with the <em>same</em> type of database), and add the migration files to the git repository, and use these files when <em>deploying</em> the database. While these are a bit cryptic, you can inspect the migration files as well. These explain <em>what</em> the migration will do exactly, to prevent any surprises.<p>You can add <code>migrate</code> to the deploy pipeline. If the migration file was inspected and tested carefully, normally that should not be much of a problem, although adding a backup step before migrating could probably make the deployment process a bit safer.</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>