<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,orm,models,database,django-models "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="non-atomic JSONFields"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>non-atomic JSONFields &#8249; antipattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>non-atomic <code>JSONField</code>s</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=4>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>Several databases introduced a JSON field in the last years. This allows storing JSON blobs efficiently, and also to some extent filtering, aggregating and updating JSON blobs. Django also introduced a <a href=https://docs.djangoproject.com/en/stable/ref/models/fields/#django.db.models.JSONField><strong><code>JSONField</code></strong> <sup>[Django-doc]</sup></a>, which will use such JSON field the database provides, if it is available. However it is counter-intuitive to <em>relational</em> databases, and often still is not done very effectively.<h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>First of all, it is not said that the database itself has a JSON field, for example MySQL introduced JSON fields in version 5.7.8. For databases older than this Django will have to fall back on a <code>CharField</code>, or <code>BinaryField</code> to store data as JSON. This means it is of course still possible to store JSON, but all sorts of filtering, aggregating, etc. now are not available, or at least not at the database side. The JSON will then also be stored just as a sequence of characters, which is often not the most effective way to store JSON anyway.<p>But a more severe problem is that it <em>often</em>, not always, but <em>often</em> violates <a href=https://en.wikipedia.org/wiki/First_normal_form><em>first normal form (1NF)</em> <sup>[wiki]</sup></a> in database normalization. Indeed, the idea of database normalization is that you should define columns and rows in such way that you never query on a <em>part</em> of a column where you filter, aggregate, update and select: one should try to maximize filtering on the <em>entire</em> value of the column, since then the column can easily be indexed. If you want to update some part of the database, you thus rewrite these columns entirely. If we have a column with a large blob, and we only want to change one value, then writing a new blob to that column is not efficient: perhaps we have to only change a few characters. Filtering also is a problem if we want to do that on the subset of a field: unless some special indexing is in place, it would mean that we thus would have to check each row, determine that specific value for example in the JSON blob, and then check if it holds for the row. This means we have to fall back to <em>linear search</em>, which typically is <em>not</em> a good idea since as the database grows, search becomes less efficient.<p>Querying JSON fields also comes with a new array of tools to do that, like the <code>-></code> operator in PostgreSQL to look into JSON blobs. While Django has lookups to work with these operators, it is extra syntax and since the "vanilla SQL" syntax is already a challenge to represent this in Django, using the extra operators for JSON is even more challenging.<p>A final reason not to use JSON blobs is that validation of the structure of JSON is harder, especially <em>referential integrity</em>, but other parts of the structure as well. A JSON field can store anything that is JSON serializable. This thus means that if we for example expect a list of dictionaries, the database will <em>not</em> check if that is indeed the case. Validators may help, but these will run when you use forms or serializers, or actively run the validators, not when you use the models directly, and definitely not when you update items in bulk.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>If the field has a certain structure, convert that structure into models, and <em>linearize</em> data. Indeed, imagine that we have a model with:<div class=sourceCode id=cb1><pre class="sourceCode python"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=im>from</span> django.conf <span class=im>import</span> settings</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a><span class=im>from</span> django.db <span class=im>import</span> models</span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb1-5><a href=#cb1-5 aria-hidden=true tabindex=-1></a><span class=kw>class</span> Order(models.Model):</span>
<span id=cb1-6><a href=#cb1-6 aria-hidden=true tabindex=-1></a>    customer <span class=op>=</span> models.ForeignKey(settings.AUTH_USER_MODEL, on_delete<span class=op>=</span>models.PROTECT)</span>
<span id=cb1-7><a href=#cb1-7 aria-hidden=true tabindex=-1></a>    lines <span class=op>=</span> models.JSONField()</span></code></pre></div><p>where <code>lines</code> for example look like:<div class=sourceCode id=cb2><pre class="sourceCode json"><code class="sourceCode json"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=ot>[</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a>    <span class=fu>{</span><span class=dt>&quot;product_id&quot;</span><span class=fu>:</span> <span class=dv>14</span><span class=fu>,</span> <span class=dt>&quot;qty&quot;</span><span class=fu>:</span> <span class=dv>25</span><span class=fu>}</span><span class=ot>,</span></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a>    <span class=fu>{</span><span class=dt>&quot;product_id&quot;</span><span class=fu>:</span> <span class=dv>13</span><span class=fu>,</span> <span class=dt>&quot;qty&quot;</span><span class=fu>:</span> <span class=dv>2</span><span class=fu>}</span></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=ot>]</span></span></code></pre></div><p>we can convert this to an extra model that has a <code>ForeignKey</code> to a <code>Product</code> and where we store the quantity, like:<div class=sourceCode id=cb3><pre class="sourceCode python"><code class="sourceCode python"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=kw>class</span> Order(models.Model):</span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a>    customer <span class=op>=</span> models.ForeignKey(settings.AUTH_USER_MODEL, on_delete<span class=op>=</span>models.PROTECT)</span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a><span class=kw>class</span> OrderLine(models.Model):</span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a>    order <span class=op>=</span> models.ForeignKey(Order, on_delete<span class=op>=</span>models.PROTECT, related_name<span class=op>=</span><span class=st>&#39;lines&#39;</span>)</span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true tabindex=-1></a>    product <span class=op>=</span> models.ForeignKey(Product, on_delete<span class=op>=</span>models.PROTECT)</span>
<span id=cb3-8><a href=#cb3-8 aria-hidden=true tabindex=-1></a>    qty <span class=op>=</span> models.PositiveIntegerField()</span></code></pre></div><p>here we can efficiently filter for orders with a <code>product_id=14</code> in it with:<div class=sourceCode id=cb4><pre class="sourceCode python"><code class="sourceCode python"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a>Order.objects.<span class=bu>filter</span>(lines__product_id<span class=op>=</span><span class=dv>14</span>)</span></code></pre></div><p>but it also ensures that each line <em>has</em> a <code>product_id</code> that refers to a valid product, that it has <code>qty</code> which is a (positive) integer, and thus that the order lines make sense. With the previous solution, it would mean less efficient searching, but it is also not said that the order lines are structured accordingly. For example we can just write <code>{"comment": "muhahahaha"}</code> to the JSON blob, which makes the <code>Order</code> invalid.<p>Only if the field has no <em>fixed</em> structure, or you see the JSON blob as an <em>atomic</em> value (we don't look for a specific key-value pair, or element when filtering, aggregating, updating), using a JSON blob is a good idea. If the structure is not fixed, it becomes indeed more complicated to translate this into models, and then using a <code>JSONField</code> might be appropriate, but still it is possible that this turns out to be a bottleneck.<h1 id=extra-tips>Extra tips</h1><p>Most of what has been said in this article is not only applicable to JSON fields, but also to array fields and other fields that introduce a composite of data. While an array field is not <em>inherently</em> bad, from the moment you start filtering on <em>elements</em> of the array, and you thus treat elements of the array <em>individually</em>, problems start to arise.</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>