<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,3nf,thirdnormalform,django-models "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Data duplication"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Data duplication &#8249; antipattern &#8249; Django antipatterns</title>
<link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Data duplication</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=4>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>Coding is often not much more than converting input into output. For example if a <code>Project</code> can have an archive date, we probably sometimes need to determine if the project is archived. In that case we check if the archive date is not <code>None</code>/<code>NULL</code>, and if that is the case, we check if the archive date is in the past.<p>It is tempting to store that in the database. After all, it can make our lives more comfortable. We could for example define a <code>Project</code> class with:<pre class=python3><code>from django.db import models


class Project(models.Model):
    archive_date = models.DateField(null=True, blank=True, default=None)
    is_archived = models.BooleanField(default=False)</code></pre><p>We can now filter on <code>Project.objects.filter(is_archived=True)</code> to get all archived projects. So the problem is solved, isn't it?<h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>It is very tempting to make an additional field. But often it is <em>not</em> a good idea. Sure we can filter on the <code>is_archived</code> column, but what keeps the <code>is_archived</code> column in sync?<p>All views that modify <code>archive_date</code> must also update <code>is_archived</code>, and vice versa. This may look simple at first, but it means that if you <code>.update(archive_date=date(2019, 11, 25))</code>, you need to update the field. If you use <code>.save(update_fields=('archive_date',))</code>, you need to remember to include <code>is_archived</code>.<p>If <code>is_archived</code> does not only depend on fields of the <code>Project</code> model, but related models, then it even gets more complicated. If for example a project is not archived if there is still a <code>Task</code> that is not archived, it means that creating a task, removing a task, updating a task, etc. all can have impact on the <code>Project</code>. So eventually it is almost impossible to tell what to do. Often one also uses <a href=https://www.django-antipatterns.com/antipattern/signals.html><em>signals</em></a> for that, a tool that has its own pitfalls.<p>To make matters even worse in the scenario described above, even if we don't do anything with the <code>Project</code> model, a <code>Project</code> can change from unarchived to archived: if we set the date on July 18<sup>th</sup>, 2035, and it is still 2025, we don't have to worry, but eventually some process will have to set <code>is_archived</code> to <code>True</code>. There is tooling that can schedule a task to run at a certain moment in time. But this is often not completely reliable: imagine that you use celery, but at a certain point celery fails, then it will not update the project in time. If you use for example a Redis database that lives and dies with a particular deploy, then when redeploying, celery does not even know anymore what tasks it was supposed to run. So while celery is definitely a good tool, it is often not good to rely too much on tasks scheduled years in advance.<p>Getting rid of functional dependencies is something already well understood in database design: <a href=https://en.wikipedia.org/wiki/Third_normal_form><em>Third Normal Form (3NF)</em></a> aims to eliminate such functional dependencies: if we need those, and we can not say through computation how a column <em>Y</em> depends on another column <em>X</em> (or multiple columns), it is usually stored in a lookup table, to prevent having to store the functional dependency multiple times, and thus risking <em>data inconsistency</em> and <em>anomalies</em>.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>Don't duplicate data in the database. We can work with a property, that just determines the value when we need it, like:<pre class=python3><code>from django.db import models
from django.utils import timezone


class Project(models.Model):
    archive_date = models.DateField(null=True, blank=True, default=None)

    @property
    def is_archived(self):
        if self.archive_date is None:
            return False
        return self.archive_date &lt;= timezone.now().date()</code></pre><p>We can also attach a setter to it if we want to set a value <code>is_archived</code>, which than handles the case accordingly:<pre class=python3><code>from django.db import models
from django.utils import timezone


class Project(models.Model):
    archive_date = models.DateField(null=True, blank=True, default=None)

    @property
    def is_archived(self):
        if self.archive_date is None:
            return False
        return self.archive_date &lt;= timezone.now().date()

    @is_archived.setter
    def is_archived(self, value):
        if value:
            self.archive_date = timezone.now().date()
        else:
            self.archive_date = None</code></pre></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>