<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,django-models "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Users controlling a primary key"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Users controlling a primary key &#8249; antipattern &#8249; Django antipatterns</title><style>pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}code span.al{color:red}code span.an{color:green}code span.at{}code span.bu{}code span.cf{color:#00f}code span.ch{color:teal}code span.cn{}code span.co{color:green}code span.cv{color:green}code span.do{color:green}code span.er{color:red;font-weight:700}code span.ex{}code span.im{}code span.in{color:green}code span.kw{color:#00f}code span.op{}code span.ot{color:#ff4000}code span.pp{color:#ff4000}code span.sc{color:teal}code span.ss{color:teal}code span.st{color:teal}code span.va{}code span.vs{color:teal}code span.wa{color:green;font-weight:700}</style><link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Users controlling a primary key</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=4>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>In Django models can be used to define records in the database. The data to populate these models often originates from the user. Every model has a single field as primary key, which is by default an <code>AutoField</code>, but can actually use (almost) any kind of field.<p>It is tempting to let the user pick values for the primary keys for some model objects. We can for example define a <code>username</code> field as primary key for the <code>User</code> model, and a lot of database design courses advise to use a <em>natural key</em> as primary key, so the following does not look strange:<div class=sourceCode id=cb1><pre class="sourceCode python"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=kw>class</span> MyUser(AbstractBaseUser):</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a>    username <span class=op>=</span> models.CharField(max_length<span class=op>=</span><span class=dv>32</span>, primary_key<span class=op>=</span><span class=va>True</span>)</span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a>    <span class=co># …</span></span></code></pre></div><p>In that case we can let the user pick their own <code>username</code> by writing a <code>ModelForm</code> with the <code>username</code> as one of the fields.<h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>There are a number of situations that might arise where updating the <code>.username</code> might have uninteded effects.<h2 id=checking-equivalence>Checking equivalence</h2><p>In Django a primary key has some special logic attached to it. In fact it is the column that identifies the <em>full</em> object. This means that <code>MyUser(username='foo')</code> is equal to <code>MyUser(username='foo')</code>, indeed:<pre class=pycon><code>&gt;&gt;&gt; MyUser(username=&#39;foo&#39;) == MyUser(username=&#39;foo&#39;)
True</code></pre><p>It thus uses that to identify a record so to speak.<h2 id=clone-a-record>Clone a record</h2><p>But a more complicated problem to handle is that Django will check if a record with the primary key exists for updating, and if not, create a record. This thus means that if you <em>change</em> the primary key of a record that already exists, and you <em>save</em> it to the database, Django will actually <em>clone</em> the record. Indeed:<pre class=pycon><code>&gt;&gt;&gt; user = MyUser.objects.get(username=&#39;foo&#39;)
&gt;&gt;&gt; user.username = &#39;bar&#39;
&gt;&gt;&gt; user.save()</code></pre><p>will <em>not</em> remove a record with the username <code>foo</code>, or probably even better, update the <code>username</code> of the record with primary key <code>'foo'</code> to <code>'bar'</code>, it will just insert a new record with <code>'bar'</code> as primary key, where all the columns are the same.<h2 id=override-an-existing-record>Override an existing record</h2><p>To make matters even worse, it allows one to even <em>edit</em> an existing record. Indeed, imagine that you have two <code>MyUser</code> records: one with <code>foo</code>, and one with <code>bar</code>, and the <code>MyUser</code> with username <code>foo</code> is changed to <code>bar</code>, it will <em>update</em> the record with primary key <code>'bar'</code>, and thus allows to override an existing record:<pre class=pycon><code>&gt;&gt;&gt; user_bar = MyUser.objects.get(username=&#39;bar&#39;)
&gt;&gt;&gt; user_foo = MyUser.objects.get(username=&#39;foo&#39;)
&gt;&gt;&gt; user_foo.username = &#39;bar&#39;
&gt;&gt;&gt; user_foo.age = 42
&gt;&gt;&gt; user_foo.save()
&gt;&gt;&gt; user_bar.refresh_from_db()
&gt;&gt;&gt; user_bar.age
42</code></pre><p>so while a <code>ModelForm</code> will indeed do a uniqness check, and thus reject that, certain views might accidentally override data if you use some ORM calls.<h2 id=security-vulnerabilities>Security vulnerabilities</h2><p>To make matters even worse, some parts of Django use the primary key in authentication routines, which makes <em>perfect sense</em>. Indeed, if you login with a user, Django will store the primary key in the session variables (for the <code>_auth_user_id</code> key). If a user somehow can trick a view in updating the username, and storing the (new) username in the session variable, it means the user can "steal" a session, and thus all of a sudden see the site like the other user would see that. Yes, that is unlikely, and requires some views with security problems in the Django site, but still it is not a good idea.<h2 id=performance-issues>Performance issues</h2><p>Django very often queries the database based on the value of a primary key. Most <code>ForeignKey</code>s for example will point to the primary key column of the model they target, and thus therefore if you need the related object, Django will make a query fetching the object with a certain value for the primary key. <code>VARCHAR</code>s are usually <em>not</em> a good data format to filter on frequently. First of all the amount of bytes is typically a lot more than that of an integer (usually four or eight bytes), but to make matters worse, the data a user enters is typically not distributed evenly. Databases nowadays have support for UUIDs storing these with 16 bytes, but if they don't Django will store this in a 32-byte long <code>VARCHAR</code>, which is usually still better than storing it with the hyphens, since these always occur at the same place, and thus don't attribute any information. Still, allowing arbitrary data to be entered can slow down the database.<p>If one uses a hashing algorithm, and the hashing algorithm and the salt are somehow known, this can even be used as a <a href=https://en.wikipedia.org/wiki/Denial-of-service_attack><em>Denial-of-Service (DOS) attack</em> vector</a>, since a malicious person can enter data in such way that the hashes collide, eventually slowing down the database completely and rendering the system unresponsive. This of course requires technical knowledge of the database, the hashing algorithm, and the salt, and therefore can generate a lot of data that collides such that the database index no longer can retrieve the corresponding record(s) efficiently.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>Primary keys should not be used in Django (and perhaps not even in databases in general) to store <em>information</em>. You could see a primary key essentially as a "token" with no special value basides representing an objects. Sure a primary key might be an integer, or a UUID, or something else, but adding up two integer primary keys makes not much sense, or doing some modulo operations. These might be integers, but this is more a technical detail to get the mechanics to work properly. In Haskell's <a href=https://hackage.haskell.org/package/persistent><strong><code>persist</code></strong> package</a>, a package to perform queries, the primary keys are wrapped in a dedicated type, exactly to prevent treating the keys as the values they use.<p>Our <code>MyUser</code> model of course needs a <code>username=…</code>, but it is better to make use of a (unique) model field for this. This avoids (most) of the problems we discussed:<div class=sourceCode id=cb5><pre class="sourceCode python"><code class="sourceCode python"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=kw>class</span> MyUser(models.Model):</span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a>    username <span class=op>=</span> models.CharField(max_length<span class=op>=</span><span class=dv>32</span>, unique<span class=op>=</span><span class=va>True</span>)</span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a>    <span class=co># …</span></span></code></pre></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>