<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=hapytex data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting." data-color=#e9c012 data-position=Right data-x_margin=18 data-y_margin=18></script><meta name=keywords content="Django,web,programming,antipattern,pattern,troubleshooting,software design,database-query,count,length,django-orm "><meta name=author content="Willem Van Onsem"><meta name=description content="A set of Django (anti)patterns: patterns and things to avoid when building a web application with Django."><meta name=twitter:image:src content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:title content="Using len(…) on a QuerySet with no further use"><meta name=og:image content="https://repository-images.githubusercontent.com/257009680/7a954900-2f5d-11eb-8d0a-c8af0596107f"><meta name=og:image:alt content="A prohibition sign in the Django color scheme."><meta name=og:image:type content="image/png"><meta name=og:type content="website"><link rel=stylesheet href=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/styles/default.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js></script><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link href=/style.css rel=stylesheet><link href=https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css rel=stylesheet><script src=https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js></script><script data-ad-client=ca-pub-9962024266760159 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script src=/script.js></script><link rel=icon href=/favicon.ico type=image/x-icon><meta name=generator content="pandoc"><title>Using len(…) on a QuerySet with no further use &#8249; antipattern &#8249; Django antipatterns</title>
<link rel=stylesheet href></head><body><a class=github-fork-ribbon href=https://github.com/hapytex/django-antipatterns data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><div class="navbar navbar-static-top"><div class=navbar-inner><div class=container><nav aria-label=section><ol class=breadcrumb><li class=breadcrumb-item><a href=/><i class="fas fa-home"></i></a><li class=breadcrumb-item><a href=/antipattern.html><i class="fas fa-ban"></i>&nbsp;
antipattern</a><li class="breadcrumb-item active" aria-current=page>Using <code>len(…)</code> on a <code>QuerySet</code> with no further use</ol></nav><ul class="nav pull-right doc-info"><li><div class=rating data-rating=3>severity:
<i class=star-1>★</i>
<i class=star-2>★</i>
<i class=star-3>★</i>
<i class=star-4>★</i>
<i class=star-5>★</i></div></ul></div></div></div><article><div class=container><div class=row><div class=span12><p>People sometimes calculate the number of records by using <code>len(…)</code>. For example, if we have a model where comments relate to a post, we can obtain the number of comments with:<pre class=python><code>number_of_comments = <b>len(</b>Comment.objects.filter(post_id=<i>id_of_post</i>)<b>)</b></code></pre><h1 id=why-is-it-a-problem>Why is it a problem?</h1><p>Because it is inefficient. It means that Django will <em>evaluate</em> the <code>QuerySet</code> and thus load all records into memory. When this is done, it will determine the number of records. But this thus means that if there are ten comments, we first will retrieve ten records, deserialize these, and then look at the length of the list. This means the database will send a lot of data to the Django/Python layer.<p>If we do <em>not</em> iterate over the <em>same</em> queryset later on, then all that data has been retrieved without any use. Indeed, the database itself can determine the number of records. This will not only minimize the bandwidth, but a database often will determine the number of records more efficiently through indexing mechanisms than counting the individual records.<h1 id=what-can-be-done-to-resolve-the-problem>What can be done to resolve the problem?</h1><p>A <code>QuerySet</code> has a <a href=https://docs.djangoproject.com/en/dev/ref/models/querysets/#count><strong><code>.count()</code></strong> method <sup>[Django-doc]</sup></a>. This will make a <code>COUNT(*) FROM …</code> query such that the database will determine the number of records. We thus can transform query at the top to:<pre class=python><code>number_of_comments = Comment.objects.filter(post_id=<i>id_of_post</i>)<b>.count()</b></code></pre><p>This is always more efficient, <em>unless</em> we later <em>iterate</em> over the <code>QuerySet</code>. Indeed, if we would determine the number of comments and then iterate over it, for example to print the comments, using <code>len(…)</code> is more efficient, because then we retrieve and count the number of records with the same query:<pre class=python><code># we here iterate over the <i>same</i> queryset, so this is more
# efficient.

qs = Comment.objects.filter(post_id=<i>id_of_post</i>)

number_of_comments = len(qs)
for comment in qs:
    print(comment)</code></pre></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>anchors.options={placement:"left",visible:"hover",icon:"¶"},anchors.add("h1,h2,h3")</script></article></body></html>